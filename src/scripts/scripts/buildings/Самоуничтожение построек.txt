Sub UpdateBuildingsWithTemplates()
    Dim provinceRange As Range
    Dim templateRange As Range
    Dim variablesRange As Range
    Dim logSheet As Worksheet
    Dim cell As Range, templateCell As Range
    Dim jsonData As Object, templateData As Object
    Dim buildings As Object, building As Object
    Dim i As Integer
    Dim buildingName As String, provinceId As String, ownerName As String
    Dim stateName As String
    Dim selfDestructionValue As Variant
    Dim logRow As Long
    
    ' Установите ссылки на диапазоны и листы
    On Error Resume Next
    Set provinceRange = Range("Провинции_ОсновнаяИнформация")
    Set templateRange = Range("Постройки_Шаблоны")
    Set variablesRange = Range("Переменные_ОсновнаяИнформация")
    Set logSheet = ThisWorkbook.Sheets("Журнал событий")
    On Error GoTo 0
    
    ' Проверка существования диапазонов и листов
    If provinceRange Is Nothing Or templateRange Is Nothing Or variablesRange Is Nothing Then
        MsgBox "Один или несколько диапазонов не найдены: 'Провинции_ОсновнаяИнформация', 'Постройки_Шаблоны', 'Переменные_ОсновнаяИнформация'", vbExclamation
        Exit Sub
    End If
    If logSheet Is Nothing Then
        MsgBox "Лист 'Журнал событий' не найден.", vbExclamation
        Exit Sub
    End If
    
    ' Получаем значение state_name из Переменные_ОсновнаяИнформация
    stateName = JsonConverter.ParseJson(variablesRange.Value)("state_name")
    
    ' Найти первую свободную строку для лога
    logRow = logSheet.Cells(logSheet.Rows.Count, 1).End(xlUp).Row + 1
    
    ' Проходим по каждой ячейке в диапазоне провинций
    For Each cell In provinceRange
        If cell.Value <> "" Then  ' Пропускаем пустые ячейки
            ' Парсим JSON данные в ячейке и проверяем успешность создания объекта
            Set jsonData = JsonConverter.ParseJson(cell.Value)
            
            If Not jsonData Is Nothing Then  ' Проверка, что jsonData был успешно создан
                ' Проверка на наличие ключа "province_id" и "owner"
                If jsonData.exists("province_id") Then
                    provinceId = jsonData("province_id")
                Else
                    provinceId = "Неизвестная"  ' Установим значение, если province_id отсутствует
                End If
                If jsonData.exists("owner") Then
                    ownerName = jsonData("owner")
                Else
                    ownerName = ""  ' Установим пустое значение, если owner отсутствует
                End If
                
                ' Проверяем, совпадает ли owner провинции со state_name
                If ownerName = stateName Then
                    ' Проверяем наличие построек
                    If Not jsonData("buildings") Is Nothing Then
                        Set buildings = jsonData("buildings")
                        
                        ' Проходим по всем зданиям в обратном порядке для безопасного удаления
                        For i = buildings.Count To 1 Step -1
                            Set building = buildings(i)
                            buildingName = building("name")
                            selfDestructionValue = Null  ' Сбрасываем значение self_destruction
                            
                            ' Ищем шаблон по имени постройки в диапазоне "Постройки_Шаблоны"
                            For Each templateCell In templateRange
                                If templateCell.Value <> "" Then
                                    Set templateData = JsonConverter.ParseJson(templateCell.Value)
                                    If templateData("name") = buildingName Then
                                        selfDestructionValue = templateData("self_destruction")
                                        Exit For  ' Используем первое найденное совпадение
                                    End If
                                End If
                            Next templateCell
                            
                            ' Если шаблон не найден
                            If IsNull(selfDestructionValue) Then
                                ' Записываем событие и удаляем постройку
                                logSheet.Cells(logRow, 1).Value = "Шаблон для постройки " & buildingName & " в провинции " & provinceId & " не найден. Постройка удалена."
                                logSheet.Cells(logRow, 2).Value = "ПРЕДУПРЕЖДЕНИЕ"
                                logRow = logRow + 1  ' Переходим к следующей свободной строке
                                buildings.Remove i  ' Удаление постройки
                            Else
                                ' Проверка статуса постройки, если шаблон найден
                                If building("status") = "Активная" Then
                                    ' Если статус "Активная", устанавливаем значение self_destruction из шаблона
                                    building("self_destruction") = selfDestructionValue
                                ElseIf building("status") = "Неактивная" Then
                                    ' Если статус "Неактивная", уменьшаем self_destruction на 1
                                    If building("self_destruction") > 0 Then
                                        building("self_destruction") = building("self_destruction") - 1
                                        
                                        ' Предупреждение, если self_destruction 3 или меньше и не равно 0
                                        If building("self_destruction") <= 3 And building("self_destruction") > 0 Then
                                            logSheet.Cells(logRow, 1).Value = "Постройка " & buildingName & " в провинции " & provinceId & " будет снесена через " & building("self_destruction") & " ходов."
                                            logSheet.Cells(logRow, 2).Value = "ВНИМАНИЕ"
                                            logRow = logRow + 1
                                        End If
                                    End If
                                    
                                    ' Если self_destruction достиг нуля, удаляем постройку и записываем событие
                                    If building("self_destruction") = 0 Then
                                        logSheet.Cells(logRow, 1).Value = "Постройка " & buildingName & " в провинции " & provinceId & " уничтожена, она слишком долго не использовалась."
                                        logSheet.Cells(logRow, 2).Value = "ВНИМАНИЕ"
                                        logRow = logRow + 1  ' Переходим к следующей свободной строке
                                        buildings.Remove i  ' Удаление постройки
                                    End If
                                End If
                            End If
                        Next i
                        
                        ' Записываем обновлённые данные обратно в ячейку провинции
                        cell.Value = JsonConverter.ConvertToJson(jsonData)
                    End If
                End If
            Else
                Debug.Print "jsonData пустой объект для ячейки: " & cell.Address & ", возможно, JSON поврежден"
            End If
        End If
    Next cell
    
    MsgBox "Обработка завершена. Постройки обновлены и удалены при необходимости."
End Sub
