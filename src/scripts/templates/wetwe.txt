Option Explicit

Sub ПроверкаПостроек()
    Dim Шаблоны As Range, Провинции As Range, Переменные As Range
    Dim cell As Range
    Dim jsonTemplate As Object, jsonProvince As Object, jsonVars As Object
    Dim templateDict As Object
    Dim templateName As String, provinceName As String
    Dim logSheet As Worksheet
    Dim stateName As String
    
    ' Настройка листа для журнала событий
    Set logSheet = ThisWorkbook.Sheets("Журнал событий")
    Dim logRow As Long
    logRow = logSheet.Cells(logSheet.Rows.Count, 1).End(xlUp).Row + 1

    ' Определение именных диапазонов
    On Error Resume Next
    Set Шаблоны = ThisWorkbook.Names("Постройки_Шаблоны").RefersToRange
    Set Провинции = ThisWorkbook.Names("Провинции_ОсновнаяИнформация").RefersToRange
    Set Переменные = ThisWorkbook.Names("Переменные_ОсновнаяИнформация").RefersToRange
    On Error GoTo 0
    
    ' Проверка на существование диапазонов
    If Шаблоны Is Nothing Or Провинции Is Nothing Or Переменные Is Nothing Then
        Debug.Print "Один из диапазонов не найден."
        Exit Sub
    End If
    
    ' Получаем значение state_name из Переменные_ОсновнаяИнформация
    On Error Resume Next
    Set jsonVars = JsonConverter.ParseJson(Переменные.Cells(1, 1).Value)
    If Not jsonVars Is Nothing Then
        stateName = jsonVars("state_name")
    Else
        Debug.Print "Ошибка: Неправильный формат JSON в Переменные_ОсновнаяИнформация."
        Exit Sub
    End If
    On Error GoTo 0
    
    ' Проверка корректности JSON и обработка шаблонов построек
    Set templateDict = CreateObject("Scripting.Dictionary")
    For Each cell In Шаблоны
        If cell.Value <> "" Then
            On Error Resume Next
            Set jsonTemplate = JsonConverter.ParseJson(cell.Value)
            On Error GoTo 0
            
            If Not jsonTemplate Is Nothing Then
                If Not IsEmpty(jsonTemplate("name")) Then
                    templateDict(jsonTemplate("name")) = jsonTemplate
                End If
            Else
                Debug.Print "Ошибка JSON в шаблоне постройки: " & cell.Address
            End If
        End If
    Next cell

    ' Обработка данных провинций и проверка построек на соответствие шаблонам
    For Each cell In Провинции
        If cell.Value <> "" Then
            On Error Resume Next
            Set jsonProvince = JsonConverter.ParseJson(cell.Value)
            On Error GoTo 0
            
            If Not jsonProvince Is Nothing Then
                ' Проверка на совпадение владельца провинции с state_name
                If Not IsEmpty(jsonProvince("owner")) And jsonProvince("owner") = stateName Then
                    Dim building As Object
                    For Each building In jsonProvince("buildings")
                        templateName = building("name")
                        
                        ' Проверка на наличие шаблона для постройки
                        If templateDict.exists(templateName) Then
                            Set jsonTemplate = templateDict(templateName)
                            
                            ' Проверка соответствия провинции критериям шаблона
                            If ПроверьСоответствие(jsonProvince, jsonTemplate) Then
                                building("status") = "Активная"
                            Else
                                building("status") = "Неактивная"
                                logSheet.Cells(logRow, 1).Value = "Провинция " & jsonProvince("province_id") & " не подходит для здания " & templateName
                                logSheet.Cells(logRow, 2).Value = "ВНИМАНИЕ"
                                logRow = logRow + 1
                            End If
                        Else
                            building("status") = "Неактивная"
                            logSheet.Cells(logRow, 1).Value = "Шаблон для постройки " & templateName & " в провинции " & jsonProvince("province_id") & " не найден. Постройка удалена."
                            logRow = logRow + 1
                        End If
                    Next building
                End If
            Else
                Debug.Print "Ошибка JSON в данных провинции: " & cell.Address
            End If
        End If
    Next cell
End Sub

' Функция проверки соответствия провинции критериям шаблона
Function ПроверьСоответствие(province As Object, template As Object) As Boolean
    ПроверьСоответствие = True ' Устанавливаем флаг по умолчанию
    ' Добавить здесь условия для проверки на основе ключей (пример проверки в комментарии)
    ' If Not ПроверьУсловие(province, template, "required_landscapes", "landscapes") Then
    '     ПроверьСоответствие = False
    ' End If
End Function
